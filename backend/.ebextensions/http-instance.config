files:
  /tmp/ssl.pre:
    mode: "000644"
    owner: root
    group: root
    content: |
      server {  
          listen          80;
          server_name     api.vet.lhei.org;
          rewrite ^/(.*)  https://api.vet.lhei.org/$1 permanent;
      }

      server {
          listen          443 ssl;
          server_name     api.vet.lhei.org;
          access_log      /var/log/nginx/api.vet.lhei.org_access.log combined;
          error_log       /var/log/nginx/api.vet.lhei.org_error.log error;

          ssl_certificate         /etc/pki/tls/certs/server.crt;
          ssl_certificate_key     /etc/pki/tls/certs/server.key;

          location /static/ {
              alias /opt/python/current/app/static/;
          }

          location / {
              proxy_pass         http://localhost:8000/;
              proxy_redirect     off;

              proxy_set_header   Host              $http_host;
              proxy_set_header   X-Real-IP         $remote_addr;
              proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
          }
      }

  /etc/pki/tls/certs/server.crt:
    mode: "000644"
    owner: root
    group: root
    content: |
      -----BEGIN CERTIFICATE-----
      MIID2TCCAsECFFFYQYUhywvGH0hMrMbqzAcUQpj0MA0GCSqGSIb3DQEBCwUAMIGo
      MQswCQYDVQQGEwJVUzERMA8GA1UECAwITWljaGlnYW4xEDAOBgNVBAcMB0RldHJv
      aXQxHzAdBgNVBAoMFldheW5lIFN0YXRlIFVuaXZlcnNpdHkxFDASBgNVBAsMC2Nz
      YzQ5OTYtZjIwMRYwFAYDVQQDDA1FdmFuIGRlIEplc3VzMSUwIwYJKoZIhvcNAQkB
      FhZldmFuamRlamVzdXNAZ21haWwuY29tMB4XDTIwMTEyNzE3NDcxNloXDTIxMTEy
      NzE3NDcxNlowgagxCzAJBgNVBAYTAlVTMREwDwYDVQQIDAhNaWNoaWdhbjEQMA4G
      A1UEBwwHRGV0cm9pdDEfMB0GA1UECgwWV2F5bmUgU3RhdGUgVW5pdmVyc2l0eTEU
      MBIGA1UECwwLY3NjNDk5Ni1mMjAxFjAUBgNVBAMMDUV2YW4gZGUgSmVzdXMxJTAj
      BgkqhkiG9w0BCQEWFmV2YW5qZGVqZXN1c0BnbWFpbC5jb20wggEiMA0GCSqGSIb3
      DQEBAQUAA4IBDwAwggEKAoIBAQC464S60c66QX36UOhNdY1JXvkuXQPT7W/AqYvv
      O1DHJOAKNgSMisipFkFhWNWecwOJKiMoo66OdMQYi40ZppwCQ8xxenqP42/1n7qN
      A1fLWdzHRBnqmGSh6hpebRi+VoiJ+/nhbEBkrB2pmDLvHcFhpboEq38NyScAENu2
      MIRJCLy4Fj79o0IuBvDfTS0imo2f2FjE1DFrqZ7/uSxO/dC51bbmecy6rmuw93xL
      mHH2yoKcQqYYPw6hNB8yr5pNKVScNOXBZm0j2QulkIZk0eq4xZAwLmg+R2OSlgSV
      PayMP+Ce0tRTpu6yCgpZ/+WmJbZtMg4U/vYgjHIMAJ+4GTVFAgMBAAEwDQYJKoZI
      hvcNAQELBQADggEBAJcfYewqJBqCTcfeEc01CJ1GjDfxT9Dsc8jKPlHdwrkKfCi6
      qrs2lTmxv5BeOmDZTQgoYbtFlgS1RniJDawUu2QGqj/mIe+kqggEXCCRLF5u3GGo
      KhgNe00n4HMm3842v7LQlaRT28u7wM0w7ecl8eT1sDh329M2zAhhf68pLEtuQZqO
      zupWJ+Rut6I4D5GrbWUKEc+KPhmZl3ffQvtr/vaexmB6d5TG7IFlGGeqg2Yo3Ipl
      5m18yp9lFM135nXQgNnxr+8SYu1XyW8LKzrC3jnMtnkYY0qNjAw1nSRIIgZyC2RJ
      HW+iEhryVwukBSmRqvIiaTOPY78oYPVvhw4diBg=
      -----END CERTIFICATE-----

  /etc/pki/tls/certs/server.key:
    mode: "000644"
    owner: root
    group: root
    content: |
      -----BEGIN RSA PRIVATE KEY-----
      MIIEpQIBAAKCAQEAuOuEutHOukF9+lDoTXWNSV75Ll0D0+1vwKmL7ztQxyTgCjYE
      jIrIqRZBYVjVnnMDiSojKKOujnTEGIuNGaacAkPMcXp6j+Nv9Z+6jQNXy1ncx0QZ
      6phkoeoaXm0YvlaIifv54WxAZKwdqZgy7x3BYaW6BKt/DcknABDbtjCESQi8uBY+
      /aNCLgbw300tIpqNn9hYxNQxa6me/7ksTv3QudW25nnMuq5rsPd8S5hx9sqCnEKm
      GD8OoTQfMq+aTSlUnDTlwWZtI9kLpZCGZNHquMWQMC5oPkdjkpYElT2sjD/gntLU
      U6busgoKWf/lpiW2bTIOFP72IIxyDACfuBk1RQIDAQABAoIBAQCRS8zglZXfVzJL
      CmNc6W54Jf2YZlFppXhXY2CmOm7/6oN2wnbUjv+Xi/sXKBvBAhHXJpq1hdbT6/9g
      YdYeP4D5bpgm2duPT19bGYQU5HmJODR3BZVvdQotBqptYz873vYtpSTz8ICwGWS9
      Ku9qXnDh7ru4i5+rD1BrhtN71ac7UiH4oS+sR4905ta+0XwWkoQGaFZL+Srhdx5i
      66rlPYwIFmsXM00FXC23xHI9yBjv0d0umnVS0TfAUijAWylKczu5WlpWnkpKALvt
      q9mE4xxOwJN480GE8Xkq/HPFD+N286tzU7v/DvjJfJoJAjZXj87Wu2LuC3aFYm8E
      HrAs/VhJAoGBAOJJp6XYC/AavVJIo8a/UalZBpj3rNUqV0bsAeBcYUVSuT+rvPqC
      qdpEsTzAbXwoLeQ8kCIvUx4GFiSBZ1pdpLvi0vLmUyaaOpeQWAObpTWpkkmkcbtE
      8nbmxDrfkH4aBfErNrELdkoev1pZ1mp2mn7T5Hdhi7H2nwnfl/Clfv6PAoGBANEz
      WHQxFDb6hzzIKAc+bu4nwYJLA4MPJlZlfwLDbiJ6I8IKsQccnoI6/x3bHfYTcUrc
      bETdkGwrMLTUwkptZH11MZuXjMX5bon3GEeueYzPqSXJTMQUjOwhyLTP5csxImiP
      qbQL+JDOfCLNqSlJgQYSDv1k5ju30V2uUwvw5fjrAoGBAMwhhYqmCp7egErqHFP9
      4rzSApGbW94wA+uGm2q560WOCm7VjfSuSmsL7JbRP/Lwi/WIbL1p06ER/IeR9Jog
      P6r+Qy27eOcp2hE/tSYMEk0GW2DzZ2V4HQIFyp8RbldTQmj8gqnTnTHf6t6mjDYe
      J+ChZUgMRuiTgYR2n6oGoTkhAoGBAM4pZI005K/9mpLKya/B1j46zZeiZzacEnLo
      GQ/XGk09wslyEd1pVcgPbeS1UER2Cpr0uHnxQ2dl9NzwIvyH65U7jgTAiAl983Jh
      IPtbNQwQhafoRg+iFPKLpKiTjOj+ZeNXWK1HctD5vBnsRT2b41vhJgaPjdjiIKDK
      r6q/31K7AoGAfRWotfaf/1RxGGNfyQzIanQnym9l+L4t0EkqXF9CFPG3DhYZhBrV
      ToJlqVwTLl82NlIYYpVPEWtC9VQQezaMC2ynKuG63l/DBN+Uig+8FJpOkWvaQUNa
      yxAHhPxfLJIZdGN1JLCZaJzPner1Mx1u9VHC9QXL/Sj89/P66//YhWA=
      -----END RSA PRIVATE KEY-----

container_commands:
  01overwrite:
    command: "sudo cp /tmp/ssl.pre /etc/nginx/conf.d/elasticbeanstalk/ssl.conf"
  02restartnginx:
    command: "sudo systemctl restart nginx"
  03waitfornginxdeath:
    command: "sleep 3"