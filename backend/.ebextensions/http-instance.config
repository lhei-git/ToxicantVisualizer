files:
  /etc/nginx/conf.d/ssl.pre:
    mode: "000644"
    owner: nginx
    group: nginx
    content: |
      server {
          listen       443 default ssl;
          server_name  localhost;
          error_page  497 https://$host$request_uri;

          ssl_certificate      /etc/letsencrypt/live/ebcert/fullchain.pem;
          ssl_certificate_key  /etc/letsencrypt/live/ebcert/privkey.pem;

          ssl_session_timeout  5m;
          ssl_protocols  TLSv1.1 TLSv1.2;
          ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";
          ssl_prefer_server_ciphers   on;

          if ($ssl_protocol = "") {
            rewrite ^ https://$host$request_uri? permanent;
          }

          location /static/ {
              alias /opt/python/current/app/static/;
          }

          location / {
              proxy_pass         http://localhost:8000/;
              proxy_redirect     off;

              proxy_set_header   Host              $http_host;
              proxy_set_header   X-Real-IP         $remote_addr;
              proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
          }
      }

container_commands:
  00_enableepel:
    command: "sudo amazon-linux-extras install epel -y"
  10_installcertbot:
    command: "sudo yum install -y certbot python-certbot-nginx"
  20_getcert:
    command: "sudo certbot certonly --debug --non-interactive --email evanjdejesus@gmail.com --agree-tos --standalone --domains api.vet.lhei.org --keep-until-expiring --pre-hook \"service nginx stop\""
  30_link:
    command: "ln -sf /etc/letsencrypt/live/api.vet.lhei.org /etc/letsencrypt/live/ebcert"
  40_config:
    command: "mv /etc/nginx/conf.d/ssl.pre /etc/nginx/conf.d/ssl.conf"
  50_restartnginx:
    command: "sudo service restart nginx"